{{- define "main" -}}

<div class="main-container">
    <div class="main-left">
        {{- /* 1. 欢迎语 */ -}}
        {{- if .Site.Params.homeInfoParams -}}
            {{- partial "home_info.html" . -}}
        {{- end -}}

        {{- /* ================================================== */ -}}
        {{- /* 2. 数据准备与过滤 (智能清洗) */ -}}
        {{- /* ================================================== */ -}}
        
        {{- /* 第一步：获取全站普通页面 */ -}}
        {{- $allPages := .Site.RegularPages -}}

        {{- /* 第二步：剔除掉功能页面 (搜索、归档) */ -}}
        {{- /* 只要 Layout 是 search 或 archives 的，统统不要 */ -}}
        {{- $allPages := where $allPages "Layout" "ne" "search" -}}
        {{- $allPages := where $allPages "Layout" "ne" "archives" -}}

        {{- /* 第三步：剔除掉用户手动隐藏的页面 (比如 "我是谁") */ -}}
        {{- /* 只要 Front Matter 里写了 hidden: true 的，统统不要 */ -}}
        {{- $allPages := where $allPages "Params.hidden" "ne" true -}}

        {{- /* -------------------------------------------------- */ -}}

        {{- /* 筛选合集 (置顶) */ -}}
        {{- $pinnedPages := where $allPages "Params.pin" true -}}
        
        {{- /* 筛选散落文章 (非置顶) */ -}}
        {{- $regularPages := where $allPages "Params.pin" "ne" true -}}

        {{- /* 3. 显示合集卡片 */ -}}
        {{- range $pinnedPages -}}
            {{- partial "series_overview_card.html" . -}}
        {{- end -}}

        <div class="posts-list">
            {{- /* 4. 显示散落文章 */ -}}
            {{- $paginator := .Paginate $regularPages -}}

            {{- range $paginator.Pages -}}
                <article class="post-entry">
                    {{- $isHidden := .Params.cover.hidden | default site.Params.cover.hiddenInList -}}
                    {{- partial "cover.html" (dict "cxt" . "IsHome" true "isHidden" $isHidden) -}}
                    
                    <header class="entry-header">
                        <h2>
                            {{- .Title -}}
                            {{- if .Draft -}}<sup><span class="entry-isdraft">&nbsp;&nbsp;[Draft]</span></sup>{{- end -}}
                        </h2>
                    </header>
                    
                    {{- if (ne .Params.hideSummary true) -}}
                    <div class="entry-content">
                        <p>{{ .Summary | plainify | htmlUnescape }}{{ if .Truncated }}...{{ end }}</p>
                    </div>
                    {{- end -}}
                    
                    <footer class="entry-footer">
                        {{- partial "post_meta.html" . -}}
                    </footer>
                    
                    <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
                </article>
            {{- end -}}
        </div>

        {{- /* 5. 分页导航 */ -}}
        {{- template "_internal/pagination.html" . -}}
    </div>

    {{- /* 侧边栏 */ -}}
    {{- if .Site.Params.profileMode.enabled -}}
    <div class="main-right">
        {{- partial "profile.html" . -}}
    </div>
    {{- end -}}
</div>

{{- end }}{{/* end main */ -}}